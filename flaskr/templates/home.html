<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.3.2/chart.min.js"></script>
    <title>Index Analysis</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <style>
.index-attribute:hover {
    color: white;
    background-color: #DC4C64;
}

#general_info {
   width: 100%;
}

#summary_div {
   display: inline-block;
   width: 1000px;
}

#cost_div {
   display: inline-block;
   width: 1000px;
}
#size_div {
   display: inline-block;
   width: 666px;
   background-color: white;
}
#index_overview {
    display: inline-block;
}

#details_per_selection {
    background-color: #F0F0F0;
    padding: 10px;
}

.selection_details {
    background-color: white;
    margin: 10px;
    padding: 10px;
    width: 500px;
    float: left;
}

    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-light">
      <a class="navbar-brand" href="#">
        <img src="{{ url_for('static', filename='images/PostgreSQL_logo.png') }}" width="30" height="30" class="d-inline-block align-top" alt=""> Index Analysis
      </a>
      <div class="navbar-item active">
          TPC-H (SF=10)
      </div>
    </nav>
<div>
    <div id="general_info">
        <div id="summary_div"><canvas id="summaryChart" max-width="1000" max-height="1000"></canvas></div>
        <div id="cost_div" class=""><canvas id="queryCostsChart" max-width="1000" max-height="1000"></canvas></div>
    </div>
    <div id="details_per_selection">
    </div>
</div>

    <script>
    let apiUrl = 'http://127.0.0.1:5000/';

    function getJson(url) {
        let request = new XMLHttpRequest();
        request.open("GET", url, false);
        request.send(null);
        return JSON.parse(request.responseText);
    }

    var selectedAlgorithms = [];
    var querySizeCharts = []

    var summaryData = getJson(apiUrl + 'summary');
    console.log(summaryData);

    function summaryOnClickHandler(event, elements, chart) {
        if (elements.length == 1) {
            let algorithm = summaryData[elements[0].datasetIndex].label;
            let memory_budget = summaryData[elements[0].datasetIndex].data[elements[0].index].x;
            let index = selectedAlgorithms.findIndex((element) => element[0] == algorithm && element[1] == memory_budget);
            let approach_id = algorithm + '__' + memory_budget;
            if (index == -1) {
                <!-- new approach got selected -->
                selectedAlgorithms.push([algorithm, memory_budget]);
                console.log('remove');
                $('#cost_div').removeClass('d-none');
                var result = getJson(apiUrl + 'query_cost_per_algorithm/' + JSON.stringify([[algorithm, memory_budget]]));
                for (i = 0; i < result.length; i++) {
                    queryCostsChart.data.datasets.push(result[i]);
                }
                let borderColor = result[0].borderColor;
                let backgroundColor = result[0].backgroundColor;
                console.log(borderColor, backgroundColor);
                $('#cost_div').removeClass('d-none');
                <!-- TODO: add approach details -->
                var result = getJson(apiUrl + 'index_sizes/' + JSON.stringify([algorithm, memory_budget]));
                var dom_element = '<div id="' + approach_id + '__details" class="selection_details">\n' +
            '<h3>' + algorithm + ' ' +  memory_budget + ' GB</h3>\n' +
            '<div id="' + approach_id + 'size_div"><canvas id="' + approach_id + '__indexSizeChart" max-width="666" max-height="666"></canvas></div>\n' +
            '<div id="' + approach_id + '__index_overview">' + JSON.stringify(result.index_names) + '</div>\n' +
        '</div>\n'
                $('#details_per_selection').append($(dom_element));

                let ctx = document.getElementById(approach_id + '__indexSizeChart').getContext('2d');
                let querySizeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: result.index_names,
                        datasets: [{
                            label: 'estimated index size',
                            data: result.index_sizes,
                            backgroundColor: [backgroundColor],
                            borderColor: [borderColor],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                querySizeCharts.push(querySizeChart);

                constructIndexOverview(approach_id, result.index_names);
            }
            else {
                <!-- previously selected approach got deselected -->
                selectedAlgorithms.splice(index, 1);
                querySizeCharts.splice(index, 1);
                let index2 = queryCostsChart.data.datasets.findIndex((element) => element.label == algorithm + ' ' + memory_budget);
                console.log('chart costs remove ' + index2);
                queryCostsChart.data.datasets.splice(index2, 1);
<!--                if (selectedAlgorithms.length == 0) {-->
<!--                    $('#cost_div').addClass('d-none');-->
<!--                }-->
                <!-- remove approach details -->
                console.log('#' + approach_id + '__details remove');
                $(document.getElementById(approach_id + '__details')).remove();
            }
            console.log(selectedAlgorithms);
            queryCostsChart.update();
        }
    }

    var ctx = document.getElementById('summaryChart').getContext('2d');
    queryCostsChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: summaryData
        },
        options: {
            showLine: true,
            scales: {
                x: {
                    type: 'linear',
                    beginAtZero: true
                },
                y: {
                }
            },
            onClick: summaryOnClickHandler,
        }
    });

    var data = getJson(apiUrl + 'index_sizes/' + JSON.stringify(["ILP", 4000]));

    var ctx = document.getElementById('queryCostsChart').getContext('2d');
    queryCostsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.queries,
            datasets: [{
                label: 'no indexes',
                data: data.query_cost_no_index
            },
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });


    function remove(element) {
        var parent = element.parentNode.parentNode;
        var removed_attribute = element.textContent;
        let index_overview = element.parentNode.parentNode.parentNode;
        console.log(index_overview.id);
        console.assert(index_overview.id.split('__').slice(-1) == 'index_overview');

        let index_information = parent.id.split('__')
        console.assert(index_information.length == 3);

        let algorithm = index_information[0];
        let memory_budget = index_information[1];

        let index_id = index_information[2];
        console.log(index_id);
        console.log(parent.id, element.textContent);

        if (element.parentNode.children.length == 1) {
            // remove index
            element.parentNode.parentNode.remove();

        } else {
            // remove index attribute
            element.remove();
        }

        let index_names = [];
        for (i=0; i<index_overview.children.length; i++) {
            let index = [];
            for (j=0; j<index_overview.children[i].children[0].children.length; j++) {
                index.push(index_overview.children[i].children[0].children[j].textContent);
            }
            index_names.push(index);
        }
        console.log(index_names);
        let result = getJson(apiUrl + 'index_calculation/' + JSON.stringify(index_names));
        console.log(result.index_sizes);

        let position = selectedAlgorithms.findIndex((element) => element[0] == algorithm && element[1] == memory_budget);
        querySizeCharts[position].data.datasets[0].data = result.index_sizes;
        querySizeCharts[position].data.labels = index_names;
        querySizeCharts[position].update();

        // use individual updates for smooth animation
        for (i = 0; i < result.query_costs.length; i++) {
            queryCostsChart.data.datasets[position+1].data[i] = result.query_costs[i];
        }
        queryCostsChart.update()

    }

    function constructIndexOverview(approach_id, indexes) {
        let index_overview_element = document.getElementById(approach_id + '__index_overview');
        index_overview_element.innerHTML = '';
        for (var i = 0; i < indexes.length; i++) {
            var index = indexes[i];
            var index_element = '<div id="' + approach_id + '__index' + i + '" ><div class="btn-group" role="group">';
                for (var j = 0; j < index.length; j++) {
                    index_element +=  '<button type="button" class="btn btn-default index-attribute" value="' + index[j] + '" onclick="remove(this)">' + index[j] + '<span class="glyphicon glyphicon-remove"></button>\n';
            }
            index_element +='</div></div>'
            index_overview_element.innerHTML += index_element;
        }
    }

    </script>
</body>

</html>